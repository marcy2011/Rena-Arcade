<!DOCTYPE html>
<html lang="it">
  <head>
    <title id="page-title">Rena Arcades - Download</title>
    <link rel="icon" type="image/x-icon" href="logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <meta property="og:url" content="renaarcade.altervista.org" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap"
    />
    <link
      href="https://api.fontshare.com/v2/css?f[]=open-sauce-one@400&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: black;
        color: white;
        font-family: "Open Sauce One", sans-serif;
        min-height: 100vh;
        cursor: url("cursore.png"), auto;
      }

      main {
        padding-top: 150px !important;
      }

      .floating-navbar {
        position: fixed;
        top: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 50px;
        padding: 15px 40px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 90%;
        max-width: 1000px;
        z-index: 1000;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
      }

      .floating-navbar:hover {
        background: rgba(0, 0, 0, 0.4);
        transform: translateX(-50%) translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      }

      .header-brand {
        text-decoration: none;
      }

      .header-brand:hover {
        transform: none;
      }

      .navbar-nav {
        display: flex;
        align-items: center;
        gap: 30px;
        flex: 1;
        justify-content: center;
      }

      .nav-link {
        color: white;
        text-decoration: none;
        font-size: 16px;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 20px;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
        line-height: 1;
      }

      .nav-link::before {
        display: none;
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
      }

      .nav-link.active {
        background: rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2);
      }

      .navbar-account {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-shrink: 0;
      }

      .account-menu {
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: none;
      }

      .menu-icon {
        width: 28px;
        height: 28px;
        transition: none;
        display: block;
      }

      .menu-icon path {
        transition: none;
      }

      .profile-menu-container {
        position: relative;
        z-index: 200;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #profile-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
      }

      .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .profile-pic:hover {
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      }

      .default-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        font-weight: 600;
        border: 2px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .profile-menu {
        display: none;
        position: absolute;
        top: 65px;
        right: -15px;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 15px;
        width: 200px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 1000;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .profile-menu.active {
        display: block;
        z-index: 1001;
      }

      .profile-menu-item {
        display: flex;
        align-items: center;
        padding: 10px;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        margin-bottom: 5px;
      }

      .profile-menu-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .profile-menu-item i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
      }

      .profile-menu-divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 10px 0;
      }

      .language-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .language-option:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .language-option.active {
        background: rgba(255, 255, 255, 0.15);
      }

      .language-content {
        display: flex;
        align-items: center;
      }

      .language-flag {
        width: 20px;
        height: 15px;
        margin-right: 10px;
        border-radius: 3px;
      }

      .check-icon {
        width: 16px;
        height: 16px;
        stroke: #4ade80;
        stroke-width: 2;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .language-option.active .check-icon {
        opacity: 1;
      }

      @media screen and (max-width: 768px) {
        .floating-navbar {
          width: 95%;
          padding: 12px 20px;
          top: 20px;
          justify-content: space-between;
        }

        .profile-menu-container {
          order: 1;
          flex-grow: 1;
          display: flex;
          justify-content: flex-start;
          margin-left: -7px;
        }

        .navbar-logo {
          order: 2;
          position: static;
          left: auto;
          transform: none;
          flex-shrink: 0;
          display: flex;
          justify-content: center;
          align-items: center;
          flex-grow: 0;
          height: 100%;
        }

        .navbar-nav {
          display: none;
        }

        .navbar-account {
          order: 3;
          display: flex;
          align-items: center;
          gap: 10px;
          margin-left: 0;
          flex-grow: 1;
          justify-content: flex-end;
        }

        .menu-icon {
          width: 28px;
          height: 28px;
          transform: translateY(-1px) scaleX(-1);
        }

        .profile-menu {
          left: 0 !important;
          right: auto !important;
          transform: none !important;
        }
      }

      @media screen and (min-width: 769px) {
        .floating-navbar {
          top: 30px;
          max-width: 1100px;
        }

        .navbar-nav {
          display: flex;
          order: 2;
        }

        .navbar-logo {
          order: 1;
        }

        .profile-menu-container {
          order: 3;
        }

        .navbar-account {
          display: none;
        }
      }

      @media screen and (max-width: 480px) {
        .floating-navbar {
          padding: 8px 16px;
        }

        .menu-icon {
          width: 24px;
          height: 24px;
        }
      }

      #custom-menu {
        display: none;
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        border-radius: 15px;
        padding: 15px;
        backdrop-filter: blur(20px);
        z-index: 99999999;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }

      #custom-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      #custom-menu ul li {
        margin-bottom: 10px;
      }

      #custom-menu ul li a {
        display: flex;
        align-items: center;
        color: #fff;
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      #custom-menu ul li a:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
      }

      #custom-menu ul li a img {
        margin-right: 10px;
        border-radius: 5px;
      }

      #custom-menu ul li a span {
        font-size: 16px;
      }

      #custom-menu ul li a.has-svg span {
        margin-left: 10px;
      }

      .custom-menu-svg {
        width: 22px;
        height: 22px;
        max-width: 100%;
        max-height: 100%;
      }

      main {
        padding-top: 120px;
      }

      @media (max-width: 767px) {
        #custom-menu {
          display: none !important;
        }
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      ::selection {
        background-color: white;
        color: black;
      }

      *:focus {
        outline: none;
      }

      * {
        -webkit-tap-highlight-color: transparent;
      }

      .login-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .login-popup.active {
        opacity: 1;
        visibility: visible;
      }

      .login-popup-content {
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 30px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .close-popup {
        position: absolute;
        top: 15px;
        right: 15px;
        color: rgba(255, 255, 255, 0.6);
        font-size: 22px;
        cursor: pointer;
        transition: color 0.2s ease;
      }

      .close-popup:hover {
        color: white;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top: 4px solid #fff;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .context-menu-svg {
        width: 22px !important;
        height: 22px !important;
        margin-right: 10px;
      }

      .navbar-logo {
        position: relative;
      }

      .navbar-logo .header-brand {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: block;
      }

      .navbar-logo-img {
        height: 55px;
        display: block;
        border-radius: 30px;
      }

      @media screen and (min-width: 769px) {
        .navbar-logo-img {
          margin-left: 30px;
        }
      }

      body,
      html {
        margin: 0;
        padding: 0;
        font-family: "Helvetica Neue", Arial, sans-serif;
        background-color: black;
        color: white;
      }

      .page-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      .download-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        margin-top: 2rem;
      }

      .app-logo {
        border-radius: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        width: 160px;
        height: 160px;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
        border: 3px solid rgba(255, 255, 255, 0.1);
      }

      .app-logo:hover {
        transform: scale(1.05);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .app-title {
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
        background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 400% 400%;
        animation: gradientShift 3s ease infinite;
      }

      .download-buttons {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-top: 2rem;
        width: 100%;
        max-width: 400px;
      }

      .download-button {
        padding: 15px 30px;
        text-transform: uppercase;
        border-radius: 50px;
        font-size: 18px;
        font-weight: 600;
        color: black;
        background: white;
        cursor: pointer;
        box-shadow: transparent;
        border: 1px solid white;
        transition: all 0.3s ease;
        user-select: none;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .download-button:hover,
      .download-button:focus {
        border: 1px solid white;
        transform: translateY(-3px);
      }

      .store-badge {
        width: 200px;
        height: auto;
        transition: all 0.3s ease;
        border-radius: 15px;
      }

      .store-badge:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      }

      .features-section {
        margin-top: 4rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        padding: 0 1rem;
      }

      .feature-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        text-align: center;
      }

      .feature-card:hover {
        transform: translateY(-8px);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
      }

      .feature-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #4ecdc4;
      }

      .feature-title {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
      }

      .feature-description {
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.6;
      }

      .page-title {
        text-align: center;
        margin-bottom: 1rem;
        font-size: 2.5rem;
        font-weight: 600;
      }

      .page-subtitle {
        text-align: center;
        margin-bottom: 3rem;
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.7);
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      @media screen and (max-width: 768px) {
        .app-title {
          font-size: 2rem;
        }

        .download-button {
          padding: 12px 25px;
          font-size: 16px;
        }

        .features-section {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <nav class="floating-navbar">
      <div class="profile-menu-container">
        <div id="profile-button"></div>
        <div class="profile-menu" id="profile-menu">
          <a
            href="https://rena.altervista.org/account.php"
            class="profile-menu-item"
            id="account-link"
          >
            <i class="fas fa-user"></i>
            <span
              data-translate-it="Il mio account"
              data-translate-en="My Account"
              >Il mio account</span
            >
          </a>
          <div class="profile-menu-divider"></div>
          <div
            class="profile-menu-item"
            style="pointer-events: none; opacity: 0.8"
          >
            <i class="fas fa-language"></i>
            <span data-translate-it="Lingua" data-translate-en="Language"
              >Lingua</span
            >
          </div>
          <div
            class="language-option"
            data-lang="it"
            onclick="translatePage('it')"
          >
            <div class="language-content">
              <img
                src="https://renadeveloper.altervista.org/bandierait.png"
                class="language-flag"
                alt="Italiano"
              />
              <span>Italiano</span>
            </div>
            <svg
              class="check-icon"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M5 13l4 4L19 7"
              ></path>
            </svg>
          </div>
          <div
            class="language-option"
            data-lang="en"
            onclick="translatePage('en')"
          >
            <div class="language-content">
              <img
                src="https://renadeveloper.altervista.org/bandieraen.png"
                class="language-flag"
                alt="English"
              />
              <span>English</span>
            </div>
            <svg
              class="check-icon"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M5 13l4 4L19 7"
              ></path>
            </svg>
          </div>
        </div>
      </div>

      <div class="navbar-logo">
        <a class="header-brand" href="https://renaarcade.altervista.org">
          <img
            src="logo-ra-transparent.png"
            alt="Rena Arcades"
            class="navbar-logo-img"
          />
        </a>
      </div>

      <div class="navbar-nav">
        <a href="https://renaarcade.altervista.org" class="nav-link">
          <img
            src="https://gcsapp.altervista.org/homebanner.png"
            alt="Home"
            width="19"
          />
          <span>Home</span>
        </a>
        <a
          href="https://renaarcade.altervista.org/giochi.html"
          class="nav-link"
        >
          <img
            src="https://gcsapp.altervista.org/giochibanner.png"
            alt="Giochi"
            width="20"
          />
          <span data-translate-it="Giochi" data-translate-en="Games"
            >Giochi</span
          >
        </a>
        <a
          href="https://renaarcade.altervista.org/download.html"
          class="nav-link active"
        >
          <img src="downloadbanner.png" alt="Download" width="22" />
          <span>Download</span>
        </a>
      </div>

      <div class="navbar-account">
        <div class="account-menu">
          <a href="https://renaarcade.altervista.org/menu.html">
            <svg
              class="menu-icon"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              transform="rotate(0)matrix(-1, 0, 0, 1, 0, 0)"
              stroke="#ffffff"
            >
              <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
              <g
                id="SVGRepo_tracerCarrier"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></g>
              <g id="SVGRepo_iconCarrier">
                <path
                  d="M4 6H20M4 12H14M4 18H9"
                  stroke="#ffffff"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                ></path>
              </g>
            </svg>
          </a>
        </div>
      </div>
    </nav>

    <div id="custom-menu">
      <ul>
        <li>
          <a href="https://renaarcade.altervista.org"
            ><img
              src="https://gcsapp.altervista.org/homebanner.png"
              alt="Image 1"
              width="20"
            /><span>Home</span></a
          >
        </li>
        <li>
          <a href="https://renaarcade.altervista.org/giochi.html"
            ><img
              src="https://gcsapp.altervista.org/giochibanner.png"
              alt="Image 3"
              width="20"
            /><span data-translate-it="Giochi" data-translate-en="Games"
              >Giochi</span
            ></a
          >
        </li>
        <li>
          <a href="https://renaarcade.altervista.org/download.html"
            ><img src="downloadbanner.png" alt="Image 5" width="20" /><span
              >Download</span
            ></a
          >
        </li>
      </ul>
    </div>

    <div class="login-popup" id="loginPopup">
      <div class="login-popup-content">
        <span class="close-popup" id="closeLoginPopup">&times;</span>
        <h3
          data-translate-it="Accesso in corso..."
          data-translate-en="Logging in..."
        >
          Accesso in corso...
        </h3>
        <p
          data-translate-it="Stai per essere reindirizzato alla pagina di login di Rena ID"
          data-translate-en="You will be redirected to Rena ID login page"
        >
          Stai per essere reindirizzato alla pagina di login di Rena ID
        </p>
        <div style="text-align: center; margin-top: 20px">
          <div class="spinner" style="margin: 0 auto"></div>
        </div>
      </div>
    </div>

    <main class="page-content">
      <h1
        class="page-title"
        data-translate-it="Download"
        data-translate-en="Download"
      >
        Download
      </h1>
      <p
        class="page-subtitle"
        data-translate-it="Scarica l'app Rena Arcades per una migliore esperienza di gioco"
        data-translate-en="Download the Rena Arcades app for a better gaming experience"
      >
        Scarica l'app Rena Arcades per una migliore esperienza di gioco
      </p>

      <div class="download-section">
        <img src="logo.png" alt="Rena Arcades Logo" class="app-logo" />
        <h2 class="app-title">Rena Arcades App</h2>

        <div class="download-buttons">
          <a
            href="https://apk.e-droid.net/apk/app3059219-p1uklj.apk?v=3"
            class="download-button"
          >
            <i class="fas fa-download"></i>
            <span>Scarica APK</span>
          </a>

          <a
            href="https://renastore.altervista.org/rena-arcades.html"
            target="_blank"
          >
            <img
              src="https://renadeveloper.altervista.org/downloadrs.png"
              alt="Download On The Rena Store"
              class="store-badge"
            />
          </a>
        </div>
      </div>
    </main>

    <script>
      document.addEventListener("contextmenu", function (e) {
        e.preventDefault();
        if (window.innerWidth > 768) {
          var menu = document.getElementById("custom-menu");
          menu.style.display = "block";
          menu.style.left = e.pageX + "px";
          menu.style.top = e.pageY + "px";
        }
      });

      document.addEventListener("click", function (event) {
        var menu = document.getElementById("custom-menu");
        if (
          menu &&
          (!menu.contains(event.target) || event.target.tagName === "A")
        ) {
          menu.style.display = "none";
        }
      });

      document.addEventListener("click", function (event) {
        var menu = document.getElementById("custom-menu");
        if (
          menu &&
          (!menu.contains(event.target) || event.target.tagName === "A")
        ) {
          menu.style.display = "none";
        }
      });

      let isVerifyingToken = false;
      let tokenVerificationInterval = null;

      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM completamente caricato");
        loadSavedLanguage();
        handleTokenFromURL();
        setupEventListeners();
        checkLoginStatus();
      });

      function setupEventListeners() {
        console.log("Impostazione event listeners");

        const profileButton = document.getElementById("profile-button");
        const profileMenu = document.getElementById("profile-menu");

        if (profileButton && profileMenu) {
          profileButton.addEventListener("click", function (e) {
            e.stopPropagation();
            profileMenu.classList.toggle("active");
          });

          document.addEventListener("click", function () {
            profileMenu.classList.remove("active");
          });

          profileMenu.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        }

        const closePopup = document.getElementById("closeLoginPopup");
        const loginPopup = document.getElementById("loginPopup");

        if (closePopup && loginPopup) {
          closePopup.addEventListener("click", function () {
            loginPopup.classList.remove("active");
          });
        }

        const menuIcon = document.querySelector(".menu-icon");
        if (menuIcon && menuIcon.closest("a")) {
          menuIcon.closest("a").addEventListener("click", function (e) {
            e.preventDefault();
            window.location.href =
              "https://renaarcade.altervista.org/menu.html";
          });
        }
      }

      function openCrossDomainLogin() {
        console.log("Apertura login cross-domain");
        document.getElementById("loginPopup").classList.add("active");

        const loginUrl = `https://rena.altervista.org/login.php?external_domain=${encodeURIComponent(
          window.location.origin
        )}`;

        const loginWindow = window.open(
          loginUrl,
          "RenaLogin",
          "width=500,height=600,scrollbars=no,resizable=no"
        );

        if (!loginWindow) {
          document.getElementById("loginPopup").classList.remove("active");
          alert(
            "Il browser ha bloccato la popup. Per favore consenti le popup per questo sito."
          );
          return;
        }

        const checkWindowClosed = setInterval(() => {
          if (loginWindow.closed) {
            clearInterval(checkWindowClosed);
            document.getElementById("loginPopup").classList.remove("active");
            checkLoginStatus();
          }
        }, 500);

        setTimeout(() => {
          if (!loginWindow.closed) {
            loginWindow.close();
            document.getElementById("loginPopup").classList.remove("active");
            alert("Tempo scaduto. Riprova.");
          }
        }, 30000);
      }

      function handleTokenFromURL() {
        console.log("Controllo token dall'URL");
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");
        const user_id = urlParams.get("user_id");
        const username = urlParams.get("username");

        if (token && user_id && username) {
          console.log("Token trovato nell'URL, salvataggio dati utente");
          const userData = {
            status: "success",
            user_id: user_id,
            username: username,
            token: token,
            lastVerification: Date.now(),
          };

          localStorage.setItem("user_data", JSON.stringify(userData));
          updateProfileUI(userData);
          startTokenVerification();
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );
        } else {
          checkLoginStatus();
        }
      }

      function checkLoginStatus() {
        console.log("Controllo stato login...");
        const savedUserData = localStorage.getItem("user_data");

        if (savedUserData) {
          try {
            const userData = JSON.parse(savedUserData);
            console.log("Dati utente trovati:", userData);

            updateProfileUI(userData);

            if (userData.token && !isVerifyingToken) {
              const now = Date.now();
              const lastVerification = userData.lastVerification || 0;

              if (now - lastVerification > 5000) {
                isVerifyingToken = true;
                console.log("Avvio verifica token dopo ritardo");

                setTimeout(() => {
                  verifyToken(userData.token)
                    .then((valid) => {
                      console.log("Risultato verifica token:", valid);
                      isVerifyingToken = false;

                      if (!valid) {
                        console.log(
                          "Token non valido, tentativo di refresh..."
                        );
                        refreshUserData();
                      } else {
                        userData.lastVerification = Date.now();
                        localStorage.setItem(
                          "user_data",
                          JSON.stringify(userData)
                        );
                      }
                    })
                    .catch((error) => {
                      console.error("Errore verifica token:", error);
                      isVerifyingToken = false;
                    });
                }, 1000);
              }
            }
          } catch (e) {
            console.error("Errore parsing dati utente:", e);
            localStorage.removeItem("user_data");
            showLoginUI();
          }
        } else {
          console.log("Nessun dato utente trovato");
          showLoginUI();
        }
      }

      window.addEventListener("message", function (event) {
        console.log(
          "Messaggio ricevuto:",
          event.data,
          "da origine:",
          event.origin
        );

        const allowedOrigins = [
          "https://rena.altervista.org",
          "https://renadeveloper.altervista.org",
        ];

        if (!allowedOrigins.includes(event.origin)) {
          console.log("Messaggio da origine non autorizzata:", event.origin);
          return;
        }

        if (event.data && event.data.status === "success") {
          console.log("Login successful, salvataggio dati utente");

          const userData = {
            status: "success",
            user_id: event.data.user_id,
            username: event.data.username,
            token: event.data.token,
            profile_photo: event.data.profile_photo,
            lastVerification: Date.now(),
          };

          localStorage.setItem("user_data", JSON.stringify(userData));

          updateProfileUI(userData);
          startTokenVerification();

          document.getElementById("loginPopup").classList.remove("active");
        }
      });

      function updateProfileUI(data) {
        console.log("Aggiornamento UI profilo con dati:", data);
        const profileButton = document.getElementById("profile-button");
        const accountLink = document.getElementById("account-link");

        if (!profileButton) {
          console.error("Pulsante profilo non trovato");
          return;
        }

        profileButton.innerHTML = "";

        if (
          data &&
          (data.logged_in === true || data.status === "success" || data.user_id)
        ) {
          const username = data.username || data.user_id || "Utente";

          if (data.profile_photo) {
            console.log(
              "Tentativo di caricamento foto profilo:",
              data.profile_photo
            );
            const img = document.createElement("img");
            img.className = "profile-pic";
            img.alt = "Foto profilo";
            img.src = data.profile_photo;

            img.onerror = function () {
              console.log(
                "Errore caricamento foto profilo, uso avatar di default"
              );
              this.remove();
              const defaultAvatar = document.createElement("div");
              defaultAvatar.className = "default-avatar";
              defaultAvatar.textContent = username.charAt(0).toUpperCase();
              profileButton.appendChild(defaultAvatar);
            };

            img.onload = function () {
              console.log("Foto profilo caricata con successo");
            };

            profileButton.appendChild(img);
          } else {
            console.log("Nessuna foto profilo, uso avatar di default");
            const defaultAvatar = document.createElement("div");
            defaultAvatar.className = "default-avatar";
            defaultAvatar.textContent = username.charAt(0).toUpperCase();
            profileButton.appendChild(defaultAvatar);
          }

          if (accountLink) {
            accountLink.href = `https://rena.altervista.org/account.php?user_id=${data.user_id}`;
            accountLink.onclick = null;
            accountLink.querySelector("span").textContent = "Il mio account";
            accountLink
              .querySelector("span")
              .setAttribute("data-translate-it", "Il mio account");
            accountLink
              .querySelector("span")
              .setAttribute("data-translate-en", "My Account");
          }

          console.log("UI profilo aggiornata per utente loggato");
        } else {
          console.log("UI profilo impostata per utente non loggato");
          const loginButton = document.createElement("div");
          loginButton.className = "default-avatar";
          loginButton.innerHTML = '<i class="fas fa-user"></i>';
          loginButton.onclick = openCrossDomainLogin;
          profileButton.appendChild(loginButton);

          if (accountLink) {
            accountLink.href = "#";
            accountLink.onclick = function (e) {
              e.preventDefault();
              openCrossDomainLogin();
            };
            accountLink.querySelector("span").textContent = "Accedi";
            accountLink
              .querySelector("span")
              .setAttribute("data-translate-it", "Accedi");
            accountLink
              .querySelector("span")
              .setAttribute("data-translate-en", "Login");
          }
        }
      }

      function showLoginUI() {
        console.log("Mostra UI login");
        const profileButton = document.getElementById("profile-button");
        const accountLink = document.getElementById("account-link");

        if (profileButton && accountLink) {
          profileButton.innerHTML =
            '<div class="default-avatar"><i class="fas fa-user"></i></div>';

          const span = accountLink.querySelector("span");
          if (span) {
            span.setAttribute("data-translate-it", "Accedi");
            span.setAttribute("data-translate-en", "Login");
            span.textContent = "Accedi";
          }

          accountLink.onclick = function (e) {
            e.preventDefault();
            openCrossDomainLogin();
          };

          accountLink.href = "#";
        }
      }

      async function verifyToken(token) {
        console.log("Verifica token in corso...");
        if (!token) return false;

        try {
          const response = await fetch(
            "https://rena.altervista.org/verify_token.php",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ token: token }),
            }
          );

          console.log("Status risposta:", response.status);
          console.log("Status text:", response.statusText);

          const result = await response.json();
          console.log("Risultato verifica completo:", result);

          return result.valid === true;
        } catch (error) {
          console.error("Errore durante la verifica del token:", error);
          return true;
        }
      }

      function refreshUserData() {
        console.log("Refresh dati utente");
        const savedUserData = localStorage.getItem("user_data");

        if (savedUserData) {
          try {
            const userData = JSON.parse(savedUserData);
            if (userData.token) {
              fetch("https://rena.altervista.org/get_user_data.php", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ token: userData.token }),
              })
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Network response was not ok");
                  }
                  return response.json();
                })
                .then((data) => {
                  if (data.status === "success") {
                    const updatedUserData = {
                      ...userData,
                      ...data,
                      lastVerification: Date.now(),
                    };
                    localStorage.setItem(
                      "user_data",
                      JSON.stringify(updatedUserData)
                    );
                    updateProfileUI(updatedUserData);
                  } else {
                    console.log("Refresh fallito, ma mantengo dati locali");
                  }
                })
                .catch((error) => {
                  console.error(
                    "Errore durante l'aggiornamento dei dati utente:",
                    error
                  );
                });
            }
          } catch (e) {
            console.error("Errore parsing dati utente:", e);
          }
        }
      }

      function startTokenVerification() {
        console.log("Avvio verifica periodica token");
        if (tokenVerificationInterval) {
          clearInterval(tokenVerificationInterval);
        }

        tokenVerificationInterval = setInterval(() => {
          const savedUserData = localStorage.getItem("user_data");
          if (savedUserData) {
            try {
              const userData = JSON.parse(savedUserData);
              if (userData.token && !isVerifyingToken) {
                isVerifyingToken = true;
                verifyToken(userData.token)
                  .then((valid) => {
                    isVerifyingToken = false;
                    if (!valid) {
                      console.log("Token non valido, disconnessione");
                      localStorage.removeItem("user_data");
                      showLoginUI();
                      clearInterval(tokenVerificationInterval);
                    }
                  })
                  .catch((error) => {
                    console.error("Errore verifica token:", error);
                    isVerifyingToken = false;
                  });
              }
            } catch (e) {
              console.error("Errore parsing dati utente:", e);
              localStorage.removeItem("user_data");
              showLoginUI();
              clearInterval(tokenVerificationInterval);
            }
          } else {
            clearInterval(tokenVerificationInterval);
          }
        }, 30000);
      }

      function loadSavedLanguage() {
        const savedLang = localStorage.getItem("preferred_language") || "it";
        translatePage(savedLang);
      }

      function translatePage(lang) {
        console.log("Traduzione pagina in:", lang);
        const elements = document.querySelectorAll("[data-translate-it]");

        elements.forEach((element) => {
          const text = element.getAttribute(`data-translate-${lang}`);
          if (text) {
            if (element.tagName === "INPUT" || element.tagName === "TEXTAREA") {
              element.placeholder = text;
            } else {
              element.textContent = text;
            }
          }
        });

        document.querySelectorAll(".language-option").forEach((option) => {
          option.classList.remove("active");
        });

        const activeOption = document.querySelector(
          `.language-option[data-lang="${lang}"]`
        );
        if (activeOption) {
          activeOption.classList.add("active");
        }

        localStorage.setItem("preferred_language", lang);
      }
    </script>
  </body>
</html>
